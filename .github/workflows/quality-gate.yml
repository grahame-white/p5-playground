# Quality Gate Workflow
# This workflow serves as a required status check that aggregates results from
# linting and unit testing workflows using GitHub's native API.
#
# Purpose: Provides a single quality gate that can be used as a branch
# protection rule requirement. This ensures that both code quality (linting)
# and functionality (unit tests) are verified before allowing merges.
#
# Usage: Configure this workflow as a required status check in your branch
# protection rules instead of requiring individual workflow checks.
#
# Benefits:
# - Single point of control for quality gates
# - Easier branch protection configuration
# - Clear signal of overall code quality status
# - Uses GitHub-native solutions (gh CLI)
#
# Maintenance: If workflow or job names change in super-linter.yml or unit-test.yml,
# update the corresponding check names in the steps below.

name: Quality Gate

permissions: {}

on:
  pull_request:

jobs:
  quality-gate:
    name: Quality Gate Check
    runs-on: ubuntu-latest

    permissions:
      checks: read

    steps:
      - name: Wait for required checks
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Waiting for required workflow checks to complete..."

          # Function to check status of a specific check
          check_status() {
            local check_name="$1"
            local max_attempts=60
            local attempt=0
            
            while [ $attempt -lt $max_attempts ]; do
              # Get check runs for this commit
              status=$(gh api \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "/repos/${{ github.repository }}/commits/${{ github.event.pull_request.head.sha }}/check-runs" \
                --jq ".check_runs[] | select(.name == \"$check_name\") | .status + \":\" + .conclusion")
              
              if [ -z "$status" ]; then
                echo "Check '$check_name' not found yet, waiting..."
              elif echo "$status" | grep -q "completed:success"; then
                echo "✅ Check '$check_name' passed"
                return 0
              elif echo "$status" | grep -q "completed:"; then
                echo "❌ Check '$check_name' failed with status: $status"
                return 1
              else
                echo "⏳ Check '$check_name' is still running (status: $status)"
              fi
              
              attempt=$((attempt + 1))
              sleep 5
            done
            
            echo "❌ Timeout waiting for check '$check_name'"
            return 1
          }

          # Check all required workflows
          check_status "Lint Code Base" || exit 1
          check_status "Run Unit Tests (18.x)" || exit 1
          check_status "Run Unit Tests (20.x)" || exit 1

          echo ""
          echo "✅ All quality gate checks passed!"
          echo "- Super-Linter: Passed"
          echo "- Unit Tests (Node 18.x): Passed"
          echo "- Unit Tests (Node 20.x): Passed"
